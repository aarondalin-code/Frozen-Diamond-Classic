<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery • Frozen Diamond Classic</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body class="watermarkPage">
  <header class="siteHeader">
    <nav class="nav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./stats.html">Stats</a>
      <a href="./teams.html">Teams</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html" class="active">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>

    <div class="brandCenter">
      <img src="./logo.png" alt="Frozen Diamond Classic Logo" class="logoImage">
      <h1>Frozen Diamond Classic</h1>
      <div class="tagline">Tournament Central</div>
    </div>
  </header>

  <main class="wrap">
    <h2>Gallery</h2>
    <p class="muted">Photos and highlights from the tournament.</p>

    <!-- Chip Filters -->
    <div class="galleryFilterBar">
      <div class="filterRow">
        <div class="filterLabelInline">Team</div>
        <div id="teamChips" class="chipRow"></div>
      </div>

      <div class="filterRow">
        <div class="filterLabelInline">Type</div>
        <div id="typeChips" class="chipRow"></div>
      </div>

      <div class="filterMetaRow">
        <div id="resultCount" class="muted small"></div>
      </div>
    </div>

    <div id="galleryGrid" class="galleryGrid"></div>
    <p id="galleryMsg" class="muted small" style="margin-top:12px;"></p>
  </main>

  <script src="./data.js"></script>
  <script>
    function safe(v){ return String(v ?? "").trim(); }

    async function fetchCsv(url) {
      if (!url) throw new Error("Missing GALLERY_CSV_URL in data.js");
      const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url + bust, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load gallery CSV (${res.status})`);
      return await res.text();
    }

    // Robust CSV parser (handles quoted commas)
    function parseCsv(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (ch === '"') {
          if (inQuotes && next === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }

        if (!inQuotes && ch === ",") { row.push(cur); cur = ""; continue; }

        if (!inQuotes && (ch === "\n" || ch === "\r")) {
          if (ch === "\r" && next === "\n") i++;
          row.push(cur); cur = "";
          if (row.some(v => safe(v) !== "")) rows.push(row);
          row = [];
          continue;
        }

        cur += ch;
      }

      row.push(cur);
      if (row.some(v => safe(v) !== "")) rows.push(row);

      const headers = (rows.shift() || []).map(h => safe(h).replace(/\s+/g,""));
      return rows.map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = safe(r[idx]));
        return obj;
      });
    }

    function normalizeType(t){
      t = safe(t).toLowerCase();
      if (t === "photo" || t === "image") return "photo";
      if (t === "video") return "video";
      return "";
    }

    function isImageUrl(url){
      const u = safe(url).toLowerCase();
      return u.match(/\.(jpg|jpeg|png|gif|webp)(\?|#|$)/);
    }

    function isVideoUrl(url){
      const u = safe(url).toLowerCase();
      return u.match(/\.(mp4|mov|webm)(\?|#|$)/);
    }

    function youtubeEmbed(url){
      const u = safe(url);
      let m = u.match(/youtu\.be\/([^?&]+)/);
      if (m) return `https://www.youtube.com/embed/${m[1]}`;
      m = u.match(/[?&]v=([^?&]+)/);
      if (m) return `https://www.youtube.com/embed/${m[1]}`;
      m = u.match(/youtube\.com\/shorts\/([^?&]+)/);
      if (m) return `https://www.youtube.com/embed/${m[1]}`;
      return null;
    }

    // ---- Google Drive support ----
    // Accepts:
    // - https://drive.google.com/file/d/FILEID/view?...
    // - https://drive.google.com/open?id=FILEID
    // - https://drive.google.com/uc?id=FILEID&export=download
    function driveFileId(url){
      const u = safe(url);
      let m = u.match(/\/file\/d\/([^/]+)/);
      if (m) return m[1];

      m = u.match(/[?&]id=([^&]+)/);
      if (m) return m[1];

      m = u.match(/\/uc\?id=([^&]+)/);
      if (m) return m[1];

      return null;
    }

    // Reliable Drive embed for BOTH photos + videos
    function drivePreview(url){
      const id = driveFileId(url);
      if (!id) return null;
      return `https://drive.google.com/file/d/${id}/preview`;
    }

    function openButton(url, label="Open media"){
      const u = safe(url);
      return `
        <div style="padding:12px;">
          <a href="${u}" target="_blank" rel="noopener"
             style="display:inline-block; padding:10px 14px; border-radius:999px; border:1px solid rgba(0,0,0,0.12); text-decoration:none; font-weight:900;">
            ${label}
          </a>
          <div class="muted small" style="margin-top:8px;">
            (This link can’t be embedded — it will open in a new tab.)
          </div>
        </div>
      `;
    }

    function makeMediaHTML(item){
      const url = item.MediaURL;

      // ----- PHOTOS -----
      if (item.Type === "photo") {
        // direct image url
        if (isImageUrl(url)) {
          return `<img src="${url}" alt="${item.Title || "Photo"}" loading="lazy"
            onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'muted\\' style=\\'padding:12px;\\'>Image failed to load</div>';">`;
        }

        // Drive photo -> use /preview iframe (most reliable)
        const dp = drivePreview(url);
        if (dp) {
          return `<iframe src="${dp}" frameborder="0" allowfullscreen></iframe>`;
        }

        // Unknown link type -> open button
        return openButton(url, "Open photo");
      }

      // ----- VIDEOS -----
      if (item.Type === "video") {
        // YouTube
        const yt = youtubeEmbed(url);
        if (yt) {
          return `<iframe src="${yt}" frameborder="0" allowfullscreen></iframe>`;
        }

        // Direct mp4/webm
        if (isVideoUrl(url)) {
          return `
            <video controls playsinline preload="metadata" style="width:100%; height:100%; display:block;">
              <source src="${url}">
              ${openButton(url, "Open video")}
            </video>
          `;
        }

        // Drive video -> preview iframe
        const dp = drivePreview(url);
        if (dp) {
          return `<iframe src="${dp}" frameborder="0" allow="autoplay" allowfullscreen></iframe>`;
        }

        // Unknown -> open
        return openButton(url, "Open video");
      }

      return `<div class="muted" style="padding:12px;">Missing or invalid media type.</div>`;
    }

    function makeCard(item){
      const card = document.createElement("div");
      card.className = "galleryCard";

      const mediaHTML = makeMediaHTML(item);

      card.innerHTML = `
        <div class="galleryMedia">${mediaHTML}</div>
        <div class="galleryContent">
          <div class="galleryTitle">${item.Title || (item.Type === "video" ? "Video" : "Photo")}</div>
          <div class="galleryMeta">${item.Team}${item.Player ? " • " + item.Player : ""}</div>
          ${item.Credit ? `<div class="galleryCredit">${item.Credit}</div>` : ""}
        </div>
      `;
      return card;
    }

    // ---- Filter state ----
    let ALL_ITEMS = [];
    let ACTIVE_TEAM = "__all__";
    let ACTIVE_TYPE = "__all__";

    function setActiveChip(containerEl, value){
      const chips = containerEl.querySelectorAll(".filterChip");
      chips.forEach(c => c.classList.toggle("active", c.dataset.value === value));
    }

    function renderChips(){
      const teamWrap = document.getElementById("teamChips");
      const typeWrap = document.getElementById("typeChips");

      // Team chips
      const teams = Array.from(new Set(ALL_ITEMS.map(i => i.Team).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      teamWrap.innerHTML = "";
      const teamAll = document.createElement("button");
      teamAll.type = "button";
      teamAll.className = "filterChip";
      teamAll.dataset.value = "__all__";
      teamAll.textContent = "All";
      teamAll.addEventListener("click", () => {
        ACTIVE_TEAM = "__all__";
        setActiveChip(teamWrap, ACTIVE_TEAM);
        applyFilters();
      });
      teamWrap.appendChild(teamAll);

      for (const t of teams) {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "filterChip";
        b.dataset.value = t;
        b.textContent = t;
        b.addEventListener("click", () => {
          ACTIVE_TEAM = t;
          setActiveChip(teamWrap, ACTIVE_TEAM);
          applyFilters();
        });
        teamWrap.appendChild(b);
      }

      // Type chips
      typeWrap.innerHTML = "";
      const types = [
        { v: "__all__", label: "All" },
        { v: "photo", label: "Photos" },
        { v: "video", label: "Videos" }
      ];
      for (const t of types) {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "filterChip";
        b.dataset.value = t.v;
        b.textContent = t.label;
        b.addEventListener("click", () => {
          ACTIVE_TYPE = t.v;
          setActiveChip(typeWrap, ACTIVE_TYPE);
          applyFilters();
        });
        typeWrap.appendChild(b);
      }

      setActiveChip(teamWrap, ACTIVE_TEAM);
      setActiveChip(typeWrap, ACTIVE_TYPE);
    }

    function applyFilters(){
      const grid = document.getElementById("galleryGrid");
      const msg = document.getElementById("galleryMsg");
      const count = document.getElementById("resultCount");

      const filtered = ALL_ITEMS.filter(i => {
        const teamOk = (ACTIVE_TEAM === "__all__") || (i.Team === ACTIVE_TEAM);
        const typeOk = (ACTIVE_TYPE === "__all__") || (i.Type === ACTIVE_TYPE);
        return teamOk && typeOk;
      });

      grid.innerHTML = "";
      for (const item of filtered) grid.appendChild(makeCard(item));

      count.textContent = filtered.length ? `${filtered.length} item(s)` : `0 items`;
      msg.textContent = filtered.length ? "" : "No items match your filters.";
    }

    async function init(){
      const msg = document.getElementById("galleryMsg");
      try {
        const csv = await fetchCsv(window.SHEET?.GALLERY_CSV_URL);
        const rows = parseCsv(csv);

        ALL_ITEMS = rows.map(r => ({
          Type: normalizeType(r.Type),
          Title: safe(r.Title),
          Team: safe(r.Team),
          Player: safe(r.Player),
          MediaURL: safe(r.MediaURL),
          Credit: safe(r.Credit)
        }))
        .filter(x => x.Type && x.MediaURL)
        .reverse(); // newest-first

        renderChips();
        applyFilters();

      } catch(e){
        console.error(e);
        msg.textContent = `Gallery error: ${e.message}`;
      }
    }

    init();
  </script>
</body>
</html>



