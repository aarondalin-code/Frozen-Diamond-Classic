<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Roster • Frozen Diamond Classic</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body class="watermarkPage">
  <header class="siteHeader">
    <nav class="nav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./teams.html" class="active">Teams</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./uploads.html">Uploads</a>
      <a href="./gallery.html">Gallery</a>
    </nav>

    <div class="brandCenter">
      <img src="./logo.png" alt="Frozen Diamond Classic Logo" class="logoImage">
      <h1>Frozen Diamond Classic</h1>
      <div class="tagline">Tournament Central</div>
    </div>
  </header>

  <main class="wrap">
    <section class="docSection">
      <a class="link" href="./teams.html">← Back to Teams</a>

      <!-- Team Header Block -->
      <div class="teamHeaderCard" style="margin-top:10px;">
        <div class="teamHeaderLeft">
          <img id="teamLogo" class="teamLogo" src="./logo.png" alt="Team logo">
          <div>
            <div class="teamKicker" id="teamSeedKicker">Frozen Diamond Classic</div>
            <h2 class="teamTitle" id="teamName">Team</h2>
            <div class="teamMetaRow">
              <span class="teamPill" id="teamSeedPill" style="display:none;"></span>
              <a class="teamPill linkPill" href="./contacts.html">Contacts</a>
            </div>
          </div>
        </div>

        <div class="teamHeaderRight">
          <div class="coachCard">
            <div class="coachLabel">Head Coach</div>
            <div class="coachName" id="coachName">TBD</div>
            <div class="coachLinks">
              <a id="coachEmail" class="coachLink" href="#" style="display:none;">Email</a>
              <a id="coachPhone" class="coachLink" href="#" style="display:none;">Call/Text</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Roster -->
      <div class="card" style="margin-top:12px;">
        <div class="cardBody">
          <p class="muted" id="teamSub">Roster</p>
          <div class="divider"></div>
          <div id="rosterGrid" class="rosterGrid"></div>

          <p class="muted small" style="margin-top:12px;">
            Rosters update automatically when the Google Sheet roster is updated and published.
          </p>
        </div>
      </div>
    </section>
  </main>

  <!-- Player Modal -->
  <div id="playerModal" class="modalOverlay" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modalClose" id="modalCloseBtn" aria-label="Close">✕</button>
      <div id="modalBody"></div>
    </div>
  </div>

  <script src="./data.js"></script>

  <script>
    function safe(v){ return String(v || "").trim(); }

    function teamSlug(name) {
      return safe(name)
        .toLowerCase()
        .replace(/&/g, "and")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
    }

    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function fetchCsv(url) {
      if (!url) throw new Error("Missing CSV URL in data.js");
      const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url + bust, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to fetch CSV (${res.status})`);
      return await res.text();
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      const rows = lines.map(line => line.split(","));
      const headers = (rows.shift() || []).map(h => String(h).trim().replace(/\s+/g, ""));
      return rows
        .filter(r => r.some(x => String(x).trim() !== ""))
        .map(r => Object.fromEntries(headers.map((h, i) => [h, String(r[i] ?? "").trim()])));
    }

    function openModal(player) {
      const overlay = document.getElementById("playerModal");
      const body = document.getElementById("modalBody");

      const name = safe(player.Name) || "Player";
      const team = safe(player.Team) || "—";
      const num = safe(player.Number);
      const pos = safe(player.Position);
      const bats = safe(player.Bats);
      const throws = safe(player.Throws);
      const fact = safe(player.FunFact);
      const photo = safe(player.PhotoURL);

      body.innerHTML = `
        <div class="profileHeader">
          <div class="profilePhoto">
            ${photo ? `<img src="${photo}" alt="${name}">` : `<div class="profilePhotoPlaceholder">No Photo</div>`}
          </div>
          <div class="profileInfo">
            <h2 class="profileName" id="modalTitle">${name}</h2>
            <div class="muted"><strong>Team:</strong> ${team}</div>
            <div class="muted">
              ${num ? `<strong>#</strong> ${num}` : ""}${(num && pos) ? " • " : ""}${pos ? `<strong>Pos:</strong> ${pos}` : ""}
            </div>
            <div class="muted small">
              ${bats ? `Bats: ${bats}` : ""}${(bats && throws) ? " • " : ""}${throws ? `Throws: ${throws}` : ""}
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <h3 class="subhead">Fun Fact</h3>
        <p>${fact || `<span class="muted">Add a fun fact in the roster sheet (FunFact column).</span>`}</p>
      `;

      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden", "false");
      document.body.classList.add("noScroll");
    }

    function closeModal() {
      const overlay = document.getElementById("playerModal");
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden", "true");
      document.body.classList.remove("noScroll");
    }

    function sortRoster(roster) {
      return roster.sort((a, b) => {
        const na = Number(safe(a.Number));
        const nb = Number(safe(b.Number));
        const aHas = Number.isFinite(na);
        const bHas = Number.isFinite(nb);

        if (aHas && bHas && na !== nb) return na - nb;
        if (aHas && !bHas) return -1;
        if (!aHas && bHas) return 1;

        return safe(a.Name).localeCompare(safe(b.Name));
      });
    }

    function setTeamHeader({ slug, displayName, seed, coach }) {
      const nameEl = document.getElementById("teamName");
      const subEl = document.getElementById("teamSub");
      const seedPill = document.getElementById("teamSeedPill");
      const seedKicker = document.getElementById("teamSeedKicker");
      const logoEl = document.getElementById("teamLogo");

      nameEl.textContent = displayName || slug;
      subEl.textContent = "Roster";

      // Seed
      if (Number.isFinite(seed)) {
        seedPill.style.display = "inline-flex";
        seedPill.textContent = `Seed ${seed}`;
        seedKicker.textContent = `Frozen Diamond Classic • Seed ${seed}`;
      } else {
        seedPill.style.display = "none";
        seedKicker.textContent = "Frozen Diamond Classic";
      }

      // Logo with fallback
      const logoSrc = coach?.logo || (window.TEAM_INFO?.[slug]?.logo) || window.DEFAULT_TEAM_LOGO || "./logo.png";
      logoEl.src = logoSrc;
      logoEl.alt = `${displayName || slug} logo`;
      logoEl.onerror = () => { logoEl.src = window.DEFAULT_TEAM_LOGO || "./logo.png"; };

      // Coach
      const coachName = document.getElementById("coachName");
      const coachEmail = document.getElementById("coachEmail");
      const coachPhone = document.getElementById("coachPhone");

      coachName.textContent = coach?.coachName || "TBD";

      const emailVal = safe(coach?.coachEmail);
      if (emailVal && emailVal !== "TBD") {
        coachEmail.style.display = "inline-flex";
        coachEmail.textContent = emailVal;
        coachEmail.href = `mailto:${emailVal}`;
      } else {
        coachEmail.style.display = "none";
      }

      const phoneVal = safe(coach?.coachPhone);
      if (phoneVal) {
        coachPhone.style.display = "inline-flex";
        coachPhone.textContent = phoneVal;
        coachPhone.href = `tel:${phoneVal.replace(/[^\d+]/g, "")}`;
      } else {
        coachPhone.style.display = "none";
      }
    }

    function renderRoster(roster) {
      const grid = document.getElementById("rosterGrid");
      grid.innerHTML = "";

      for (const p of roster) {
        const name = safe(p.Name) || "Player";
        const num = safe(p.Number);
        const pos = safe(p.Position);

        const card = document.createElement("button");
        card.type = "button";
        card.className = "playerCardBtn";
        card.innerHTML = `
          <div class="playerTop">
            <div class="playerName">${name}</div>
            <div class="playerNum">${num ? "#" + num : ""}</div>
          </div>
          <div class="playerMeta">${pos || "—"}</div>
          <div class="playerLink">Tap for profile →</div>
        `;
        card.addEventListener("click", () => openModal(p));
        grid.appendChild(card);
      }
    }

    (async function init(){
      try {
        const slug = safe(getParam("team"));
        if (!slug) throw new Error("Missing ?team= in URL");

        // Load roster + teams (seed)
        const [rosterCsv, teamsCsv] = await Promise.all([
          fetchCsv(window.SHEET?.ROSTER_CSV_URL),
          fetchCsv(window.SHEET?.TEAMS_CSV_URL)
        ]);

        const rosterRows = parseCsv(rosterCsv);
        const teamRows = parseCsv(teamsCsv);

        // Find displayName from TEAM_INFO first; else from roster/slug
        const info = window.TEAM_INFO?.[slug] || {};
        const allRosterTeams = Array.from(new Set(rosterRows.map(r => safe(r.Team)).filter(Boolean)));
        const rosterDisplay = allRosterTeams.find(t => teamSlug(t) === slug) || "";

        const displayName = info.name || rosterDisplay || slug;

        // Seed (from Teams tab TeamName/Seed)
        let seed = NaN;
        for (const r of teamRows) {
          const nm = safe(r.TeamName);
          if (nm && teamSlug(nm) === slug) {
            const s = Number(safe(r.Seed));
            if (Number.isFinite(s)) seed = s;
          }
        }

        // Coach info centralized in TEAM_INFO
        setTeamHeader({
          slug,
          displayName,
          seed,
          coach: info
        });

        // Roster filter by team slug
        const roster = rosterRows.filter(r => teamSlug(r.Team) === slug);
        const sorted = sortRoster(roster);

        // Update subtext with count
        document.getElementById("teamSub").textContent = sorted.length ? `${sorted.length} players` : "Roster not posted yet";
        renderRoster(sorted);

        // Modal close behaviors
        document.getElementById("modalCloseBtn").addEventListener("click", closeModal);
        document.getElementById("playerModal").addEventListener("click", (e) => {
          if (e.target.id === "playerModal") closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });

      } catch (err) {
        console.error(err);
        alert("Team page error: check ROSTER_CSV_URL + TEAMS_CSV_URL and TEAM_INFO in data.js.");
      }
    })();
  </script>
</body>
</html>

