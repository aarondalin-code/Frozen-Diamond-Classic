<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Roster • Frozen Diamond Classic</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body class="watermarkPage">
  <header class="siteHeader">
    <nav class="nav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./stats.html">Stats</a>
      <a href="./teams.html">Teams</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
      
    </nav>

    <div class="brandCenter">
      <img src="./logo.png" alt="Frozen Diamond Classic Logo" class="logoImage">
      <h1>Frozen Diamond Classic</h1>
      <div class="tagline">Tournament Central</div>
    </div>
  </header>

  <main class="wrap">
    <!-- Team header block -->
    <section class="card" style="margin-top:12px;">
      <div class="cardBody">
        <div class="teamHeaderBlock">
          <div class="teamHeaderLeft">
            <img id="teamLogo" class="teamHeaderLogo" src="./logo.png" alt="Team Logo">
            <div>
              <div class="muted small">Team</div>
              <h2 id="teamName" style="margin:0;">Team</h2>
              <div id="teamSubtitle" class="muted" style="margin-top:4px;"></div>
            </div>
          </div>

          <div class="teamHeaderRight">
            <div class="coachCard">
              <div class="coachLabel">Head Coach</div>
              <div class="coachName" id="coachName">TBD</div>
              <div class="coachLinks">
                <a id="coachEmail" class="coachLink" href="#" style="display:none;">Email</a>
                <a id="coachPhone" class="coachLink" href="#" style="display:none;">Call/Text</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Roster -->
    <section class="card" style="margin-top:14px;">
      <div class="cardBody">
        <div class="rosterTopRow">
          <h3 style="margin:0;">Roster</h3>
          <a class="btnSecondary" href="./teams.html">← Back to Teams</a>
        </div>

        <div id="rosterGrid" class="rosterGrid" style="margin-top:12px;"></div>
        <p id="rosterMsg" class="muted small" style="margin-top:12px;"></p>
      </div>
    </section>
  </main>

  <!-- Player modal -->
  <div id="modalOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modalClose" id="modalCloseBtn" type="button">✕</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script src="./data.js"></script>
  <script>
    // -----------------------------
    // Helpers
    // -----------------------------
    function safe(v){ return String(v ?? "").trim(); }

    function normalizePhoneForTel(phone) {
      return safe(phone).replace(/[^\d+]/g, "");
    }

    function isBlank(v){ return safe(v) === ""; }

    function slugToPretty(slug){
      return safe(slug)
        .split("-")
        .map(s => s ? s[0].toUpperCase() + s.slice(1) : s)
        .join(" ");
    }

    function getParam(name){
      return new URLSearchParams(window.location.search).get(name) || "";
    }

    async function fetchCsv(url) {
      if (!url) throw new Error("Missing ROSTER_CSV_URL in data.js");
      const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url + bust, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to fetch roster CSV (${res.status})`);
      return await res.text();
    }

    // Robust-ish CSV parser (handles quoted commas)
    function parseCsv(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (ch === '"') {
          if (inQuotes && next === '"') { cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }

        if (!inQuotes && ch === ",") { row.push(cur); cur = ""; continue; }

        if (!inQuotes && (ch === "\n" || ch === "\r")) {
          if (ch === "\r" && next === "\n") i++;
          row.push(cur); cur = "";
          if (row.some(v => safe(v) !== "")) rows.push(row);
          row = [];
          continue;
        }

        cur += ch;
      }

      row.push(cur);
      if (row.some(v => safe(v) !== "")) rows.push(row);

      const headers = (rows.shift() || []).map(h => safe(h).replace(/\s+/g, ""));
      return rows.map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = safe(r[idx]));
        return obj;
      });
    }

    // -----------------------------
    // Page setup (team info + coach + logo)
    // -----------------------------
    function setTeamHeader(slug){
      const teamNameEl = document.getElementById("teamName");
      const subEl = document.getElementById("teamSubtitle");
      const logoEl = document.getElementById("teamLogo");

      const info = window.TEAM_INFO?.[slug] || {};
      const name = safe(info.name) || slugToPretty(slug);

      teamNameEl.textContent = name;
      document.title = `${name} • Frozen Diamond Classic`;

      // Logo (with fallback)
      const logoPath = info.logo || window.DEFAULT_TEAM_LOGO || "./logo.png";
      logoEl.src = logoPath;
      logoEl.onerror = () => { logoEl.src = window.DEFAULT_TEAM_LOGO || "./logo.png"; };

      // Optional subtitle (you can add later if you want)
      subEl.textContent = "";
    }

    function setCoachInfo(slug){
      const coach = window.TEAM_INFO?.[slug] || {};

      const coachNameEl = document.getElementById("coachName");
      const coachEmailEl = document.getElementById("coachEmail");
      const coachPhoneEl = document.getElementById("coachPhone");

      const coachName = safe(coach.coachName);
      const coachEmail = safe(coach.coachEmail);
      const coachPhone = safe(coach.coachPhone);

      coachNameEl.textContent = coachName && coachName.toLowerCase() !== "tbd" ? coachName : "TBD";

      if (coachEmail && coachEmail.toLowerCase() !== "tbd") {
        coachEmailEl.style.display = "inline-flex";
        coachEmailEl.textContent = coachEmail;
        coachEmailEl.href = `mailto:${coachEmail}`;
      } else {
        coachEmailEl.style.display = "none";
      }

      if (coachPhone && coachPhone.toLowerCase() !== "tbd") {
        coachPhoneEl.style.display = "inline-flex";
        coachPhoneEl.textContent = coachPhone;
        coachPhoneEl.href = `tel:${normalizePhoneForTel(coachPhone)}`;
      } else {
        coachPhoneEl.style.display = "none";
      }
    }

    // -----------------------------
    // Modal
    // -----------------------------
    const overlay = document.getElementById("modalOverlay");
    const modalContent = document.getElementById("modalContent");
    const closeBtn = document.getElementById("modalCloseBtn");

    function openModal(html){
      modalContent.innerHTML = html;
      overlay.classList.add("open");
      document.body.classList.add("noScroll");
      overlay.setAttribute("aria-hidden", "false");
    }

    function closeModal(){
      overlay.classList.remove("open");
      document.body.classList.remove("noScroll");
      overlay.setAttribute("aria-hidden", "true");
      modalContent.innerHTML = "";
    }

    closeBtn.addEventListener("click", closeModal);
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) closeModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    // -----------------------------
    // Roster render
    // -----------------------------
    function getPhotoSrc(player){
      const url = safe(player.PhotoURL);
      return url ? url : "./logo.png";
    }

    function renderPlayerModal(player, teamDisplayName){
      const name = safe(player.PlayerName || player.Name || "Player");
      const num = safe(player.Number);
      const pos = safe(player.Position);
      const fun = safe(player.FunFact);
      const fav = safe(player.FavoriteTeam); // NEW FIELD
      const photo = getPhotoSrc(player);

      const infoLines = [];

      if (num) infoLines.push(`<div class="profileLine"><span class="profileKey">Number</span><span class="profileVal">#${num}</span></div>`);
      if (pos) infoLines.push(`<div class="profileLine"><span class="profileKey">Position</span><span class="profileVal">${pos}</span></div>`);
      if (fav) infoLines.push(`<div class="profileLine"><span class="profileKey">Favorite MLB Team</span><span class="profileVal">${fav}</span></div>`);
      if (fun) infoLines.push(`<div class="profileLine"><span class="profileKey">Fun Fact</span><span class="profileVal">${fun}</span></div>`);

      const html = `
        <div class="profileHeader">
          <div class="profilePhoto">
            <img src="${photo}" alt="${name}" onerror="this.onerror=null; this.src='./logo.png';">
          </div>
          <div>
            <h3 id="modalTitle" class="profileName">${name}</h3>
            <div class="muted">${teamDisplayName}${num ? ` • #${num}` : ""}</div>
            <div class="profileLines" style="margin-top:12px;">
              ${infoLines.length ? infoLines.join("") : `<div class="muted small">No additional details yet.</div>`}
            </div>
          </div>
        </div>
      `;
      openModal(html);
    }

    function normalizeTeamNameForMatch(s){
      return safe(s).toLowerCase().replace(/\s+/g, " ").trim();
    }

    function buildRosterGrid(players, teamDisplayName){
      const grid = document.getElementById("rosterGrid");
      const msg = document.getElementById("rosterMsg");
      grid.innerHTML = "";

      if (!players.length){
        msg.textContent = "No roster entries found for this team yet.";
        return;
      }

      msg.textContent = "";

      // sort by Number (if numeric), then name
      players.sort((a,b) => {
        const na = Number(safe(a.Number));
        const nb = Number(safe(b.Number));
        const aHas = Number.isFinite(na);
        const bHas = Number.isFinite(nb);
        if (aHas && bHas && na !== nb) return na - nb;
        if (aHas && !bHas) return -1;
        if (!aHas && bHas) return 1;
        return safe(a.PlayerName || a.Name).localeCompare(safe(b.PlayerName || b.Name));
      });

      for (const p of players){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "playerCardBtn";

        const name = safe(p.PlayerName || p.Name || "Player");
        const num = safe(p.Number);
        const pos = safe(p.Position);
        const photo = getPhotoSrc(p);

        btn.innerHTML = `
          <div class="playerCardRow">
            <div class="playerThumb">
              <img src="${photo}" alt="${name}" onerror="this.onerror=null; this.src='./logo.png';">
            </div>

            <div class="playerCardMain">
              <div class="playerTop">
                <div class="playerName">${name}</div>
                <div class="playerNum">${num ? "#" + num : ""}</div>
              </div>
              <div class="playerMeta">${pos || ""}</div>
              <div class="playerLink">View Profile →</div>
            </div>
          </div>
        `;

        btn.addEventListener("click", () => renderPlayerModal(p, teamDisplayName));
        grid.appendChild(btn);
      }
    }

    async function init(){
      const slug = safe(getParam("team")).toLowerCase();

      if (!slug){
        document.getElementById("rosterMsg").textContent = "Missing team slug in URL. Go back to Teams page.";
        return;
      }

      setTeamHeader(slug);
      setCoachInfo(slug);

      // Determine team display name for matching roster rows
      const teamDisplayName = safe(window.TEAM_INFO?.[slug]?.name) || slugToPretty(slug);
      const teamKey = normalizeTeamNameForMatch(teamDisplayName);

      // Load roster CSV
      let rosterRows = [];
      try{
        const csv = await fetchCsv(window.SHEET?.ROSTER_CSV_URL);
        rosterRows = parseCsv(csv);
      } catch (e){
        console.error(e);
        document.getElementById("rosterMsg").textContent = "Unable to load roster right now. Check ROSTER_CSV_URL publishing.";
        return;
      }

      // Filter for this team
      const players = rosterRows.filter(r => {
        const t = normalizeTeamNameForMatch(r.Team);
        return t && t === teamKey;
      });

      buildRosterGrid(players, teamDisplayName);
    }

    init();
  </script>

  <!-- Optional: minimal styles if your styles.css doesn't already have these -->
  <style>
    /* These are safe and only apply if your main CSS doesn't already define them */
    .card{
      background: #fff;
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 14px;
      overflow: hidden;
    }
    .cardBody{ padding: 14px; }

    .btnSecondary{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border, #e2e8f0);
      background: rgba(255,255,255,0.75);
      text-decoration: none;
      color: inherit;
      font-weight: 900;
      font-size: 12px;
    }

    .teamHeaderBlock{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }
    .teamHeaderLeft{
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 260px;
    }
    .teamHeaderLogo{
      width: 64px;
      height: 64px;
      border-radius: 14px;
      border: 1px solid var(--border, #e2e8f0);
      background: #0f172a;
      object-fit: cover;
      padding: 6px;
      box-sizing: border-box;
    }

    .coachCard{
      border: 1px solid var(--border, #e2e8f0);
      border-radius: 14px;
      padding: 10px 12px;
      background: #f8fafc;
      min-width: 240px;
    }
    .coachLabel{ font-size: 11px; color: #64748b; font-weight: 900; }
    .coachName{ font-weight: 900; margin-top: 4px; }
    .coachLinks{ display:flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .coachLink{
      display:inline-flex;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border, #e2e8f0);
      text-decoration:none;
      font-weight: 900;
      font-size: 12px;
      color: inherit;
      background: #fff;
    }

    .rosterTopRow{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .playerCardRow{
      display:flex;
      gap: 12px;
      align-items: center;
    }
    .playerThumb{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid var(--border, #e2e8f0);
      overflow: hidden;
      background: #0f172a;
      flex: 0 0 auto;
    }
    .playerThumb img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .playerCardMain{ flex: 1; min-width: 0; }

    .profileLines{ display:grid; gap: 8px; }
    .profileLine{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border, #e2e8f0);
      font-weight: 800;
      font-size: 13px;
    }
    .profileKey{ color:#64748b; font-weight: 700; }
    .profileVal{ color:#0f172a; text-align: right; }

    @media (max-width: 520px){
      .teamHeaderLogo{ width: 56px; height: 56px; }
      .profileLine{ font-size: 12px; }
    }
  </style>
</body>
</html>



