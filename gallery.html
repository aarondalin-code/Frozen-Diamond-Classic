<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery • Frozen Diamond Classic</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body class="watermarkPage">
  <header class="siteHeader">
    <nav class="nav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./teams.html">Teams</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html" class="active">Gallery</a>
      <a href="./uploads.html">Uploads</a>
      
    </nav>

    <div class="brandCenter">
      <img src="./logo.png" alt="Frozen Diamond Classic Logo" class="logoImage">
      <h1>Frozen Diamond Classic</h1>
      <div class="tagline">Tournament Central</div>
    </div>
  </header>

  <main class="wrap">
    <h2>Gallery</h2>
    <p class="muted">Photos and highlights from the tournament.</p>

    <div id="galleryGrid" class="galleryGrid"></div>
  </main>

  <script src="./data.js"></script>
  <script>
    function safe(v){ return String(v || "").trim(); }

    async function fetchCsv(url) {
      const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url + bust, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load gallery");
      return await res.text();
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      const rows = lines.map(line => line.split(","));
      const headers = (rows.shift() || []).map(h => h.trim());
      return rows.map(r =>
        Object.fromEntries(headers.map((h, i) => [h, safe(r[i])]))
      );
    }

    function youtubeEmbed(url){
      const match = url.match(/(?:v=|youtu\.be\/)([^&]+)/);
      return match ? `https://www.youtube.com/embed/${match[1]}` : null;
    }

    async function init(){
      const grid = document.getElementById("galleryGrid");

      try {
        const csv = await fetchCsv(window.SHEET.GALLERY_CSV_URL);
        const rows = parseCsv(csv);

        rows.reverse(); // newest first

        for(const item of rows){
          const card = document.createElement("div");
          card.className = "galleryCard";

          const type = safe(item.Type).toLowerCase();
          const title = safe(item.Title);
          const team = safe(item.Team);
          const player = safe(item.Player);
          const credit = safe(item.Credit);
          const media = safe(item.MediaURL);

          let mediaHTML = "";

          if(type === "photo"){
            mediaHTML = `<img src="${media}" alt="${title}" loading="lazy">`;
          }

          if(type === "video"){
            const embed = youtubeEmbed(media);
            if(embed){
              mediaHTML = `
                <iframe 
                  src="${embed}" 
                  frameborder="0" 
                  allowfullscreen>
                </iframe>
              `;
            }
          }

          card.innerHTML = `
            <div class="galleryMedia">${mediaHTML}</div>
            <div class="galleryContent">
              <div class="galleryTitle">${title}</div>
              <div class="galleryMeta">
                ${team}${player ? " • " + player : ""}
              </div>
              ${credit ? `<div class="galleryCredit">${credit}</div>` : ""}
            </div>
          `;

          grid.appendChild(card);
        }

      } catch(e){
        console.error(e);
        grid.innerHTML = "<p class='muted'>Gallery not available yet.</p>";
      }
    }

    init();
  </script>
</body>
</html>

